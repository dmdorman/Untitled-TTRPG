{{ log 'Combat Tracker' this }}
<section class="{{cssClass}} tab sidebar-tab directory flexcol combat-sidebar" id="combat" data-tab="combat">
    <header class="combat-tracker-header">
        {{#if @root.data.user.isGM}}
        <nav class="encounters flexrow" aria-label="COMBAT.NavLabel">
            <a class="combat-button combat-create" data-tooltip="COMBAT.Create">
                <i class="fas fa-plus"></i>
            </a>

            {{#if (gt @root.data.combats.length 0)}}
                <a class="combat-button combat-cycle" data-tooltip="COMBAT.EncounterPrevious"
                    {{#if @root.data.previousId}}data-document-id="{{@root.data.previousId}}"{{else}}disabled{{/if}}
                >
                    <i class="fas fa-caret-left"></i>
                </a>

                <h4 class="encounter">{{localize "COMBAT.Encounter"}} {{@root.data.currentIndex}} / {{@root.data.combats.length}}</h4>

                <a class="combat-button combat-cycle" data-tooltip="COMBAT.EncounterNext" 
                    {{#if @root.data.nextId}}data-document-id="{{@root.data.nextId}}"{{else}}disabled{{/if}}
                >
                    <i class="fas fa-caret-right"></i>
                </a>
            {{/if}}
            <a class="combat-button combat-control" data-tooltip="COMBAT.Delete" data-control="endCombat" {{#unless (eq @root.data.combats.length 0)}}disabled{{/unless}}>
                <i class="fas fa-trash"></i>
            </a>
        </nav>
        {{/if}}

        <div class="encounter-controls flexrow {{#if hasCombat}}combat{{/if}}">
            {{#if @root.data.user.isGM}}
                <a class="combat-button combat-control" data-tooltip="COMBAT.RollAll" data-control="rollAll" {{#unless turns}}disabled{{/unless}}>
                    <i class="fas fa-users"></i>
                </a>
                <a class="combat-button combat-control" data-tooltip="COMBAT.RollNPC" data-control="rollNPC" {{#unless turns}}disabled{{/unless}}>
                    <i class="fas fa-users-cog"></i>
                </a>
            {{/if}}

            {{#if (gt @root.data.combats.length 0)}}
                {{#if combat.round}}
                <h3 class="encounter-title noborder">{{localize 'COMBAT.Round'}} {{combat.round}}</h3>
                {{else}}
                <h3 class="encounter-title noborder">{{localize 'COMBAT.NotStarted'}}</h3>
                {{/if}}
            {{else}}
                <h3 class="encounter-title noborder">{{localize "COMBAT.None"}}</h3>
            {{/if}}

            {{#if @root.data.user.isGM}}
                <a class="combat-button combat-control" data-tooltip="COMBAT.InitiativeReset" data-control="resetAll"
                    {{#unless hasCombat}}disabled{{/unless}}>
                    <i class="fas fa-undo"></i>
                </a>
                <a class="combat-button combat-control" data-tooltip="{{labels.scope}}"
                    data-control="toggleSceneLink" {{#unless hasCombat}}disabled{{/unless}}>
                    <i class="fas fa-{{#unless linked}}un{{/unless}}link"></i>
                </a>
                <a class="combat-button combat-settings" data-tooltip="COMBAT.Settings" data-control="trackerSettings">
                    <i class="fas fa-cog"></i>
                </a>
            {{/if}}
        </div>
    </header>

    <ol id="combat-tracker" class="directory-list">
        {{#each @root.factions as |faction|}}
            <div>{{faction}}</div>

            {{#each (lookup @root.factionData faction)}}
                {{ log 'faction data' this }}
            {{/each}}
        {{/each}}

        {{!-- {{#each segments}}
        <li class="segment-container">
            {{#if this.length}}
                <h3 class="segment-active segment-header">Segment {{@index}}</h3>
                <ol class="segment-content" {{#unless (is_active_segment ../activeSegments @index)}} style="display:none" {{/unless}}>
                    {{#each this}}
                    <li class="combatant actor directory-item flexrow {{this.css}}" data-combatant-id="{{this.id}}" >
                        <img class="token-image" data-src="{{this.img}}" title="{{this.name}}" />
                        
                        <div class="token-name flexcol">
                            <h4>{{this.name}}</h4>
                            <h4>{{this.alias}}</h4>
                        </div>

                        <div class="token-initiative">
                            <span class="initiative">{{this.initiative}}</span>
                        </div>
                    </li>
                    {{/each}}
                </ol>
            {{else}}
                <h3 class="segment-inactive">Segment {{@index}}</h3>
            {{/if}}
        </li>
        {{/each}} --}}
    </ol>

    <ol id="combat-tracker" class="directory-list">
        {{#each segments}}
        <li class="segment-container">
            {{#if this.length}}
                <h3 class="segment-active segment-header">Segment {{@index}}</h3>
                <ol class="segment-content" {{#unless (is_active_segment ../activeSegments @index)}} style="display:none" {{/unless}}>
                    {{#each this}}
                    <li class="combatant actor directory-item flexrow {{this.css}}" data-combatant-id="{{this.id}}" >
                        <img class="token-image" data-src="{{this.img}}" title="{{this.name}}" />
                        
                        <div class="token-name flexcol">
                            <h4>{{this.name}}</h4>
                            <h4>{{this.alias}}</h4>
                        </div>

                        <div class="token-initiative">
                            <span class="initiative">{{this.initiative}}</span>
                        </div>
                    </li>
                    {{/each}}
                </ol>
            {{else}}
                <h3 class="segment-inactive">Segment {{@index}}</h3>
            {{/if}}
        </li>
        {{/each}}
    </ol>

    <nav id="combat-controls" class="directory-footer flexrow" data-tooltip-direction="UP">
        {{#if hasCombat}}
            {{#if @root.data.user.isGM}}
                {{#if round}}
                    <a class="combat-control" data-tooltip="COMBAT.RoundPrev" data-control="previousRound"><i class="fas fa-step-backward"></i></a>
                    <a class="combat-control" data-tooltip="COMBAT.TurnPrev" data-control="previousTurn"><i class="fas fa-arrow-left"></i></a>
                    <a class="combat-control center" data-control="endCombat">{{localize 'COMBAT.End'}}</a>
                    <a class="combat-control" data-tooltip="COMBAT.TurnNext" data-control="nextTurn"><i class="fas fa-arrow-right"></i></a>
                    <a class="combat-control" data-tooltip="COMBAT.RoundNext" data-control="nextRound"><i class="fas fa-step-forward"></i></a>
                {{else}}
                    <a class="combat-control center" data-control="startCombat">{{localize 'COMBAT.Begin'}}</a>
                {{/if}}
            {{else if control}}
                <a class="combat-control" data-tooltip="COMBAT.TurnPrev" data-control="previousTurn"><i class="fas fa-arrow-left"></i></a>
                <a class="combat-control center" data-control="nextTurn">{{localize 'COMBAT.TurnEnd'}}</a>
                <a class="combat-control" data-tooltip="COMBAT.TurnNext" data-control="nextTurn"><i class="fas fa-arrow-right"></i></a>
            {{/if}}
        {{/if}}
    </nav>
</section>